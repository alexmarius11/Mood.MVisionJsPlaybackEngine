var fs=require("fs"),path=require("path"),log=require("npmlog"),nopt=require("nopt"),async=require("async"),serverLib=require("./../lib/server"),commonTools=require("./../lib/common-tools"),version=commonTools.version,cliControl=commonTools.cliControl,help=commonTools.help;sdkenv=commonTools.sdkenv;appdata=commonTools.appdata;eula=commonTools.eula;var processName=path.basename(process.argv[1]).replace(/.js/,"");
process.on("uncaughtException",function(a){log.error("uncaughtException",a.toString());cliControl.end(-1)});2===process.argv.length&&process.argv.splice(2,0,"--help");var knownOpts={version:Boolean,help:Boolean,open:Boolean,port:String,level:"silly verbose info http warn error".split(" ")},shortHands={V:["--version"],h:["--help"],o:["--open"],p:["--port"],v:["--level","verbose"]},argv=nopt(knownOpts,shortHands,process.argv,2);log.heading=processName;log.level=argv.level||"warn";
log.verbose("argv",argv);eula.checkEula(function(a){if(a)return finish(a);proceed()});function proceed(){var a;argv.help?(showUsage(),cliControl.end()):argv.version?version.showVersionAndExit():a=runServer;a&&version.checkNodeVersion(function(b){async.series([a.bind(this)],finish)})}function showUsage(){help.display(processName,appdata.getConfig(!0).profile)}
function runServer(){var a,b="",e=0,c=argv.argv.remain.splice(0,1).join("");if(!c)return finish("Please check the app directory path for web server");c=fs.realpathSync(c);isNaN(argv.port)||(e=parseInt(argv.port),log.verbose("runServer()#port:",e));async.waterfall([serverLib.runServer.bind(serverLib,c,e,function(f,d){"@@ARES_CLOSE@@"===f?(d.status(200).send(),a=setTimeout(function(){cliControl.end()},2E3)):"@@GET_URL@@"===f&&(clearTimeout(a),d.status(200).send(b))}),function(a,d){if(a&&a.port){b="http://localhost:"+
a.port;var c=b+"/ares_cli/ares.html";console.log("Local server running on "+b)}argv.open&&a.port&&async.series([sdkenv.getEnvValue.bind(sdkenv,"BROWSER")],function(a,b){if(a)return d(a);serverLib.openBrowser(c,b[0])});d()},function(a){}],finish)}function finish(a,b){a?(log.error(a),log.verbose(a.stack),cliControl.end(-1)):(b&&b.msg&&console.log(b.msg),cliControl.end())}process.on("uncaughtException",function(a){console.log("Caught exception: "+a)});
