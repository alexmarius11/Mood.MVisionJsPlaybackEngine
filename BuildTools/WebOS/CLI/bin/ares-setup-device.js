var async=require("async"),fs=require("fs"),inquirer=require("inquirer"),log=require("npmlog"),nopt=require("nopt"),path=require("path"),Ssdp=require("ssdp-js"),Table=require("easy-table"),novacom=require("./../lib/novacom"),commonTools=require("./../lib/common-tools"),version=commonTools.version,cliControl=commonTools.cliControl,help=commonTools.help,appdata=commonTools.appdata,eula=commonTools.eula,setupDevice=commonTools.setupDevice,isValidDeviceName=setupDevice.isValidDeviceName,isValidIpv4=setupDevice.isValidIpv4,
isValidPort=setupDevice.isValidPort,processName=path.basename(process.argv[1]).replace(/.js/,"");process.on("uncaughtException",function(a){log.info("uncaughtException",a.toString());log.error("uncaughtException",a.stack);cliControl.end(-1)});
var knownOpts={help:Boolean,level:"silly verbose info http warn error".split(" "),version:Boolean,list:Boolean,listfull:Boolean,add:[String,null],remove:[String,null],modify:[String,null],search:Boolean,timeout:[String,null],info:[String,Array],reset:Boolean},shortHands={h:["--help"],v:["--level","verbose"],V:["--version"],l:["--list"],F:["--listfull"],i:["--info"],a:["--add"],r:["--remove"],m:["--modify"],s:["--search"],t:["--timeout"],R:["--reset"]},argv=nopt(knownOpts,shortHands,process.argv,2);
log.heading=processName;log.level=argv.level||"warn";log.verbose("argv",argv);eula.checkEula(function(a){if(a)return finish(a);proceed()});
function proceed(){var a;argv.list?setupDevice.showDeviceListAndExit():argv.listfull?setupDevice.showDeviceListAndExit("full"):argv.reset?a=reset:argv.search||argv.timeout?a=search:argv.add||argv.modify||argv.info?a=modifyDeviceInfo:argv.remove?a=removeDeviceInfo:argv.version?version.showVersionAndExit():argv.help?(help.display(processName,appdata.getConfig(!0).profile),cliControl.end()):a=interactiveInput;a&&version.checkNodeVersion(function(c){async.series([a.bind(this)],finish)})}
var options={name:argv.device},defaultDeviceInfo={profile:appdata.getConfig(!0).profile,type:"starfish",host:"127.0.0.1",port:22,username:"root",description:"new device description",files:"stream"},requiredKeys={name:!1,type:!1,host:!0,port:!0,username:!0,description:!0,files:!1,privateKeyName:!0,passphrase:!0,password:!0},questions=[],inqChoices=["add","modify"],rmChoices=["remove"],totChoices=inqChoices.concat(rmChoices),_needInq=function(a){return function(c){return-1!==c.indexOf(a)}};
function reset(a){var c=path.join(appdata.getPath(),"novacom-devices.json");async.series([function(a){fs.existsSync(c)?fs.unlink(c,a):a()},setupDevice.showDeviceList.bind(this)],function(b){a(b)})}
function replaceDefaultDeviceInfo(a){a&&(a.profile=a.profile||defaultDeviceInfo.profile,a.type=a.type||defaultDeviceInfo.type,a.host=a.host||defaultDeviceInfo.host,a.port=a.port||defaultDeviceInfo.port,a.username=a.username||defaultDeviceInfo.username,a.files=a.files||defaultDeviceInfo.files,a.description=a.description||defaultDeviceInfo.description)}
function refineJsonString(a){var c=a,b=/^['|"](.)*['|"]$/;b.test(c)&&(c=c.substring(1,a.length-1));b=/^{(.)*}$/;return b.test(c)?-1===c.indexOf('"')?c.replace(/\s*"/g,"").replace(/\s*'/g,"").replace("{",'{"').replace("}",'"}').replace(/\s*,\s*/g,'","').replace(/\s*:\s*/g,'":"'):c.replace(/\s*'/g,'"'):a}
function _queryAddRemove(a,c){var b={},e=this.resolver||(this.resolver=new novacom.Resolver);"function"===typeof a&&(c=a,a=null);async.waterfall([e.load.bind(e),e.list.bind(e),function(b,d){if(!a)return d(null,b,null);var c={};a.forEach(function(a){var d=a.name+" # "+a.address;for(idx in b)if(b[idx].name===a.name){c[d]=b[idx];c[d].op="modify";c[d].host=a.address;break}c[d]||(c[d]={name:a.name,host:a.address,op:"add"})});questions=[{type:"list",name:"discovered",message:"Select",choices:Object.keys(c)}];
inquirer.prompt(questions).then(function(a){d(null,b,c[a.discovered])})},function(a,d,c){var e=a.filter(function(a){return-1===a.conn.indexOf("novacom")}).map(function(a){return a.name});questions=[{type:"list",name:"op",message:"Select",choices:function(){return d?"modify"===d.op?inqChoices:["add"]:totChoices},filter:function(a){return a.toLowerCase()},"default":function(){return d&&d.op?d.op:null}},{type:"input",name:"device_name",message:"Enter Device Name:",when:function(a){return"add"==a.op},
"default":function(){return d&&d.name?d.name:null},validate:function(a){return 1>a.length?"Please enter device name.":-1!==e.indexOf(a)?"Device name is duplicated. Please use another name.":isValidDeviceName(a)?!0:"Invalid name. Please do not use letters starting with '%' or '$'."}},{type:"list",name:"device_name",message:"Select a device",choices:e,when:function(a){return-1!==["modify","remove"].indexOf(a.op)&&!d}}];inquirer.prompt(questions).then(function(e){a.forEach(function(a){e.device_name===
a.name&&(b=a)});b.name=e.device_name||(d?d.name:null);b.mode=e.op||(d?d.op:null);b.host=d?d.host:b.host||null;c()})}],function(a){c(a,b)})}
function _queryDeviceInfo(a,c){var b=a.mode,e=a.name,f=this.resolver||(this.resolver=new novacom.Resolver);questions=[{type:"input",name:"ip",message:"Enter Device IP address:","default":function(){return a.host||"127.0.0.1"},validate:function(a){return isValidIpv4(a)?!0:"Incorrect ip address!"},when:function(a){return _needInq(b)(inqChoices)}},{type:"input",name:"port",message:"Enter Device Port:","default":function(){return a.port||"22"},validate:function(a){return isValidPort(a)?!0:"Incorrect port number!"},
when:function(a){return _needInq(b)(inqChoices)}},{type:"input",name:"user",message:"Enter ssh user:","default":function(){return a.username||"root"},when:function(a){return _needInq(b)(inqChoices)}},{type:"input",name:"description",message:"Enter description:","default":function(){return a.description||"new device"},when:function(a){return _needInq(b)(inqChoices)}},{type:"list",name:"auth_type",message:"Select authentication",choices:["password","ssh key"],"default":function(){var b=0;a.privateKeyName&&
(b=1);return b},when:function(a){return _needInq(b)(inqChoices)}},{type:"password",name:"password",message:"Enter password:",when:function(a){return _needInq(b)(inqChoices)&&"password"==a.auth_type}},{type:"input",name:"ssh_key",message:"Enter ssh private key file name:","default":function(){return a.privateKeyName||"webos_emul"},when:function(a){return _needInq(b)(inqChoices)&&"ssh key"==a.auth_type}},{type:"input",name:"ssh_passphrase",message:"Enter key's passphrase:","default":function(){return a.passphrase||
void 0},when:function(a){return _needInq(b)(inqChoices)&&"ssh key"==a.auth_type}},{type:"confirm",name:"confirm",message:"Save ?","default":!0}];inquirer.prompt(questions).then(function(a){if(a.confirm)log.info("setup-device#interactiveInput()","Saved!");else return log.info("setup-device#interactiveInput()","Canceled!"),c(null,{msg:"Canceled"});var d={profile:appdata.getConfig(!0).profile,name:e,host:a.ip,port:a.port,description:a.description,username:a.user};if("remove"!==b)if(a.auth_type&&"password"===
a.auth_type)d.password=a.password,d.privateKey="@DELETE@",d.passphrase="@DELETE@",d.privateKeyName="@DELETE@";else if(a.auth_type&&"ssh key"===a.auth_type)d.password="@DELETE@",d.privateKey={openSsh:a.ssh_key},d.passphrase=a.ssh_passphrase||"@DELETE@",d.privateKeyName="@DELETE@";else return c(Error("Not supported auth type ("+a.auth_type+")"));replaceDefaultDeviceInfo(d);d.port&&(d.port=Number(d.port));async.series([f.load.bind(f),f.modifyDeviceFile.bind(f,b,d),setupDevice.showDeviceList.bind()],
function(a){if(a)return c(a);c(null,{msg:"Success to "+b+" a device!!"})})})}function interactiveInput(a){async.waterfall([setupDevice.showDeviceList.bind(this),function(a){console.log("** You can modify the device info in the above list, or add new device.");a()},_queryAddRemove,_queryDeviceInfo],function(c,b){a(c,b)})}
function search(a){var c=new Ssdp,b=1E3*Number(argv.timeout)||5E3,e=[],f=!1;console.log("Searching...");log.verbose("search()#timeout:",b);c.start();c.onDevice(function(a){!a.headers||!a.headers.SERVER||0>a.headers.SERVER.indexOf("WebOS")||f||log.verbose("search()# %s:%s (%s)","[Discovered]",a.name,a.address)});async.waterfall([function(d){setTimeout(function(){e=c.getList().map(function(a){f=!0;return{uuid:a.headers.USN.split(":")[1],name:a.name.replace(/\s/g,"_"),address:a.address,registered:!1}});
if(0===e.length)return console.log("No devices is discovered."),a();log.verbose("search()#discovered:",e.length);d(null,e)},b)},_queryAddRemove.bind(this),_queryDeviceInfo.bind(this)],function(b){a(b)})}function _isJson(a){try{JSON.parse(a)}catch(c){return!1}return!0}function _insertParams(a,c){var b=c.split("=");2==b.length&&(a[b[0]]=b[1],log.info("Inserting params "+b[0]+" = "+b[1]))}
function _getParams(a){var c={};argv[a]&&[].concat(argv[a]).forEach(function(a){var b;b=refineJsonString(a);_isJson(b)?c=JSON.parse(b):_insertParams(c,a)});return c}
function modifyDeviceInfo(a){try{var c=argv.add?"add":argv.modify?"modify":null;if(!c)return a(Error("Please specify an option among '--add' and '--modify'"));if(argv[c].match(/^-/))return a(Error("Please specify device name !!"));var b=_getParams(argv.info?"info":c);if(!b.name){if("true"===argv[c])return a(Error("Please specify device name !!"));b.name=argv[c]}b.privateKey&&(b.privatekey=b.privateKey);"string"===typeof b.privatekey&&(b.privateKey=b.privatekey,b.privateKey={openSsh:b.privateKey},
delete b.privatekey,b.password="@DELETE@");"undefined"!==typeof b.password&&"@DELETE@"!==b.password&&(b.privateKey="@DELETE@",b.passphrase="@DELETE@");"add"===c&&(replaceDefaultDeviceInfo(b),b.privateKey||b.password||(b.password=""));if(!isValidDeviceName(b.name))return a(Error("Invalid name!. Do not use letters starting with '%' or '$'."));if(b.host&&!isValidIpv4(b.host))return a(Error("Incorrect ip address!"));if(b.port&&!isValidPort(b.port))return a(Error("Incorrect port number!"));b.port&&(b.port=
Number(b.port));b.profile||(b.profile=defaultDeviceInfo.profile);var e=this.resolver||(this.resolver=new novacom.Resolver);async.series([e.load.bind(e),e.modifyDeviceFile.bind(e,c,b),setupDevice.showDeviceList.bind(this)],function(e){if(e)return a(e);a(null,{msg:"Success to "+c+" a device named "+b.name+"!!"})})}catch(f){a(f)}}
function removeDeviceInfo(a){try{var c=this.resolver||(this.resolver=new novacom.Resolver),b={name:argv.remove,profile:defaultDeviceInfo.profile};async.series([c.load.bind(c),c.modifyDeviceFile.bind(c,"remove",b),setupDevice.showDeviceList.bind(this)],function(b){if(b)return a(b);a(null,{msg:"Success to remove a device named "+argv.remove+"!!"})})}catch(e){a(e)}}
function finish(a,c){log.info("finish():","err:",a);a?(log.error(processName+": "+a.toString()),log.verbose(a.stack),cliControl.end(-1)):(log.info("finish():",c),c&&c.msg&&console.log(c.msg),cliControl.end())}process.on("uncaughtException",function(a){console.log("Caught exception: "+a)});
