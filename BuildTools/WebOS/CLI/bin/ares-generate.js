var fs=require("fs"),path=require("path"),nopt=require("nopt"),async=require("async"),inquirer=require("inquirer"),log=require("npmlog"),readJsonSync=require("./../lib/util/json").readJsonSync,Generator=require("./../lib/generator"),commonTools=require("./../lib/common-tools"),cliControl=commonTools.cliControl,version=commonTools.version,help=commonTools.help,errMsg=commonTools.errMsg,appdata=commonTools.appdata,eula=commonTools.eula,processName=path.basename(process.argv[1]).replace(/.js/,"");
process.on("uncaughtException",function(a){log.error("*** "+processName+": "+a.toString());log.info("uncaughtException",a.stack);cliControl.end(-1)});2===process.argv.length&&process.argv.splice(2,0,"--help");var idx;(-1!==(idx=process.argv.indexOf("--list"))||-1!==(idx=process.argv.indexOf("-l")))&&process.argv[idx+1]&&process.argv[idx+1].toString().match(/^-/)&&process.argv.splice(idx+1,0,"true");
var knownOpts={help:Boolean,version:Boolean,list:String,overwrite:Boolean,servicename:String,template:String,property:[String,Array],"no-query":Boolean,init:Boolean,level:"silly verbose info http warn error".split(" ")},shortHands={h:"--help",V:"--version",l:"--list",f:"--overwrite",t:"--template",p:"--property",s:"--servicename",nq:"--no-query",i:"--init",v:["--level","verbose"]},argv=nopt(knownOpts,shortHands,process.argv,2);log.heading=processName;log.level=argv.level||"warn";
eula.checkEula(function(a){if(a)return finish(a);proceed()});function proceed(){var a;argv.help?(showUsage(),cliControl.end()):argv.close?a=close:argv.version?version.showVersionAndExit():a=argv.list?list:argv.init?init:generate;a&&version.checkNodeVersion(function(b){async.series([a.bind(this)],finish)})}
var generator,config=appdata.getConfig(!0),tmplFileName=config.templateFileName,options={tmplFile:path.join(__dirname,"./../lib/json/",tmplFileName),overwrite:argv.overwrite,tmplName:argv.template,listType:argv.list,props:argv.property||[],appinfo:{},svcName:argv.servicename,query:argv.hasOwnProperty("query")?argv.query:!0,out:argv.argv.remain[0]};function showUsage(a){a?help.display(processName,appdata.getConfig(!0).profile,a):help.display(processName,appdata.getConfig(!0).profile)}
function getGenerator(){generator||(generator=new Generator(options.tmplFile));return generator}function list(a){getGenerator().showTemplates(options.tmplFile,options.listType);a()}
function parsePropArgs(){var a=options.props,b=options.appinfo;1===a.length&&-1!==a[0].indexOf("{")&&-1!==a[0].indexOf("}")&&0===(a[0].split("'").length-1)%2&&(a[0]=a[0].replace(/\'/g,'"'));a.forEach(function(a){try{var c=JSON.parse(a);for(k in c)b[k]=c[k]}catch(f){c=a.split("="),2===c.length?b[c[0]]=c[1]:log.warn("Ignoring invalid arguments:",a)}})}
function getQueryFile(a,b){var d="query-"+b+".json",c=path.join(__dirname,"./../lib/json",a,d);fs.existsSync(c)||(c=path.join(__dirname,"./../lib/json",d));return c}function queryInfo(a){a=readJsonSync(a);var b=[];for(q in a){var d={type:"input"};d.name=q;d.message=a[q].query;d["default"]=a[q]["default"];b.push(d)}return inquirer.prompt(b,function(a){return a})}
function generate(a){var b=getGenerator(),d=b.getTemplates();if(!options.tmplName)for(var c in d)if(d[c]["default"]){options.tmplName=c;break}if(!options.tmplName)return a(Error("please set template name."));if(!options.out)return a(Error("please set output directory."));parsePropArgs();Promise.resolve().then(function(){var a=!!options.overwrite,c=!!options.query,d=path.resolve(options.out),e=b.existOutDir(d);return inquirer.prompt([{type:"confirm",name:"overwrite",message:"The directory already exists, overwrite?",
"default":!1,when:function(b){return!a&&c&&e}}]).then(function(a){options.overwrite=a.overwrite||options.overwrite;if(e&&!options.overwrite)throw Error(d+" is not empty. Please check the directory.");})}).then(function(){var a=d[options.tmplName];if(!a)throw"Invalid template name";if(a.type){if(options.query&&1>Object.keys(options.appinfo).length&&a.type.match(/(app$|appinfo$)/))return a=getQueryFile(config.profile,"app"),queryInfo(a).then(function(a){for(i in a)options.appinfo[i]=a[i]});if(options.query&&
1>Object.keys(options.appinfo).length&&a.type.match(/(^Hosted)/))return a=getQueryFile(config.profile,"hosted"),queryInfo(a).then(function(a){for(i in a)options.appinfo[i]=a[i]});if(options.query&&!options.svcName&&a.type.match(/(service$|serviceinfo$)/))return a=getQueryFile(config.profile,"service"),queryInfo(a).then(function(a){a.id&&(options.svcName=a.id)})}}).then(function(){return b.generate(options).then(function(){finish(null,{msg:"Success"})})})["catch"](function(a){finish(a)})}
function init(a){getGenerator().init(options).then(function(){finish(null,{msg:"Success"})})["catch"](function(a){finish(a)})}function finish(a,b){log.info("finish():","err:",a);a?(log.error(processName+": "+a.toString()),log.verbose(a.stack),cliControl.end(-1)):(b&&b.msg&&console.log(b.msg),cliControl.end())};
