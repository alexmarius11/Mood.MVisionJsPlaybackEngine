var async=require("async"),Table=require("easy-table"),novacom=require("./novacom");
(function(){function g(b){return-1===["$","%"].indexOf(b[0])}function m(b){return b.match(/^(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))$/)}function n(b){return(new String(b)).match(/^[0-9]+$/)}function k(b,d){return d&&"function"===typeof d?b?setImmediate(d,null,b):setImmediate(d):b}function l(b,d){var f=[],a=new novacom.Resolver;async.waterfall([a.load.bind(a),a.list.bind(a),function(e,a){Array.isArray(e)&&
e.forEach(function(c){var e,a,d=c.conn.concat([]);e=c.username&&c.host&&c.port?c.username+"@"+c.host+":"+c.port:c.id;a={profile:c.profile,name:c.name,deviceinfo:{},connection:c.conn||["ssh"],details:{platform:c.type}};1===d.length&&-1!==d.indexOf("novacom")?(a.deviceinfo.uid=c.id,a.details.type=c.name.slice(0,3)):(a.deviceinfo={ip:c.host,port:String(c.port),user:c.username},a.details.password=c.password,a.details.privatekey=c.privateKeyName,a.details.passphrase=c.passphrase,a.details.description=
c.description);c.id&&(a.deviceinfo.uid=c.id,a.details.type=c.name.slice(0,3));f.push("full"===b?a:{name:c.name,info:e,connection:c.conn||"ssh",profile:c.profile})});a(f)}],function(a){k(a,d)})}var h={};"undefined"!==typeof module&&module.exports&&(module.exports=h,module.exports.isValidDeviceName=g,module.exports.isValidIpv4=m,module.exports.isValidPort=n);h.showDeviceListAndExit=function(b,d){b=b||"list";async.waterfall([l.bind(this,b),function(d,a){if("full"===b)console.log(JSON.stringify(d,null,
4));else{var e=new Table;d.forEach(function(a){g(a.name)&&(e.cell("name",a.name),e.cell("deviceinfo",a.info),e.cell("connection",a.connection),e.cell("profile",a.profile),e.newRow())});console.log(e.toString())}a()}],function(b){process.exit(0)})};h.showDeviceList=function(b){async.waterfall([l.bind(this,"list"),function(b,f){var a=new Table;b.forEach(function(b){g(b.name)&&(a.cell("name",b.name),a.cell("deviceinfo",b.info),a.cell("connection",b.connection),a.cell("profile",b.profile),a.newRow())});
console.log(a.toString());f()}],function(d){k(d,b)})}})();
