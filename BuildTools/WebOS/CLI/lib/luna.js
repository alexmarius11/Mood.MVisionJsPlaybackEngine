var npmlog=require("npmlog"),Eof=require("./eof");
(function(){var c=npmlog;c.heading="luna";c.level="http";var q={send:function(b,d,k,m,g){function n(a){f+=a;try{c.verbose("luna#send()","JSON line:",f),e=JSON.parse(f),f="",c.verbose("luna#send()","JSON object:",e),!1===e.returnValue?(h.destroy(),g(Error("luna-send command failed"+(e.errorText?" ("+e.errorText+")":e.errorMessage?" ("+e.errorMessage+")":"")))):m(e,function(a,b){c.verbose("luna#send()","err:",a,"value:",b);if(a||b)c.verbose("luna#send()","closing exec stream"),g(a,b)})}catch(p){}}var l=
b&&b.session,h=new Eof,e;h.pause();d=["luna:/",d.service,d.folder,d.method].join("/");c.verbose("luna#send()","calling:",d+" '"+JSON.stringify(k)+"'");b=b&&b.nReplies?"-n "+b.nReplies+" ":"-i ";l.run(l.getDevice().lunaSend+" "+b+d+" '"+JSON.stringify(k)+"'",h,function(a){(Buffer.isBuffer(a)?a.toString():a).split(/\r?\n/).forEach(n)},process.stderr,function(a){a&&g(a)});var f=""},sendWithoutErrorHandle:function(b,d,k,m,g){function n(a){f+=a;try{c.verbose("luna#send()","JSON line:",f),e=JSON.parse(f),
f="",c.verbose("luna#send()","JSON object:",e),m(e,function(a,b){c.verbose("luna#send()","err:",a,"value:",b);if(a||b)c.verbose("luna#send()","closing exec stream"),g(a,b)})}catch(p){}}var l=b&&b.session,h=new Eof,e;h.pause();d=["luna:/",d.service,d.folder,d.method].join("/");c.verbose("luna#send()","calling:",d+" '"+JSON.stringify(k)+"'");b=b&&b.nReplies?"-n "+b.nReplies+" ":"-i ";l.run(l.getDevice().lunaSend+" "+b+d+" '"+JSON.stringify(k)+"'",h,function(a){(Buffer.isBuffer(a)?a.toString():a).split(/\r?\n/).forEach(n);
c.verbose("luna#send()","_onData:")},process.stderr,function(a){a&&g(a)});var f=""}};"undefined"!==typeof module&&module.exports&&(module.exports=q)})();
