var async=require("async"),fs=require("fs"),log=require("npmlog"),mkdirp=require("mkdirp"),path=require("path"),shelljs=require("shelljs"),Validator=require("jsonschema").Validator,clone=require("./util/objclone").deepCopy,Cli=function(){function d(b,c,a){return a&&"function"===typeof a?c?setImmediate(a,b,c):setImmediate(a,b):b||c}function l(b,c){var a={resultValue:!1,err:null},e={id:"test",type:"array",items:{$ref:"/deviceSchema"}},d=new Validator;try{if(d.addSchema(b,"/deviceSchema"),(a=d.validate(c,
e))&&0<a.errors.length){e="Invalid device info.";for(idx in a.errors){var e=e.concat("\n"),f=a.errors[idx].property+" "+a.errors[idx].message;null!=(a=/instance\[*.*\]*\./g.exec(f))&&(f=f.substring(a[0].length));e=e.concat(f)}a.err=Error(e)}else a.resultValue=!0}catch(h){a.err=h}return a}function g(){if(k)return k;k=this;if(!this.inialized){var b,c,a;b=path.resolve(process.env.APPDATA||process.env.HOME||process.env.USERPROFILE);a={config:{dir:path.join(__dirname,"json"),file:"config.json"},commands:{dir:path.join(__dirname,
"json"),file:"command-service.json"},deviceList:{dir:path.join(__dirname,"json"),file:"novacom-devices.json"},deviceListSchema:{dir:path.join(__dirname,"schema"),file:"NovacomDevices.schema"}};for(key in a){c=path.join(a[key].dir,a[key].file);var d=key;this[d]=JSON.parse(fs.readFileSync(c));this[d+"File"]=c}b=this.config.dataDir?path.join(b,this.config.dataDir):path.join(b,".webos");c=path.join(a.deviceList.dir,a.deviceList.file);a=path.join(b,a.deviceList.file);fs.existsSync(b)||mkdirp.sync(b);try{var g=
JSON.parse(fs.readFileSync(a)),f=l(this.deviceListSchema,g);f&&f.resultValue?this.deviceList=g:(log.verbose("cliAppData() schema check failure:",a),log.verbose("cliAppData() result:",f),log.verbose("cliAppData() copy "+c+" to "+a),shelljs.cp("-f",c,a))}catch(h){log.verbose("cliAppData()#err:",h),log.verbose("cliAppData() copy "+c+" to "+a),shelljs.cp("-f",c,a)}this.deviceListFile=a;this.workDir=b;this.inialized=!0}}var k;g.prototype={getPath:function(b){return d(null,this.workDir,b)},getAppDir:function(b){return d(null,
path.join(__dirname,".."),b)},getConfig:function(b){return d(null,clone(this.config),b)},compareProfile:function(b,c){c(null,b.toLowerCase()===this.config.profile.toLowerCase())},compareProfileSync:function(b){return b.toLowerCase()===this.config.profile.toLowerCase()},getDeviceList:function(b,c){return d(null,clone(this.deviceList),c)},getCommandService:function(b){return d(null,clone(this.commands),b)},setDeviceList:function(b,c){try{var a=l(this.deviceListSchema,b);if(a&&!a.resultValue)return d(a.err||
"invalid data",this.deviceList,c);this.deviceList=b;fs.writeFileSync(this.deviceListFile,JSON.stringify(this.deviceList,null,"\t"))}catch(e){return d(e,this.deviceList,c)}return d(null,this.deviceList,c)},setConfig:function(b,c){try{this.config=b,fs.writeFileSync(this.configFile,JSON.stringify(this.config,null,"\t"))}catch(a){return d(a,this.config,c)}return d(null,this.config,c)}};return g}();"undefined"!==typeof module&&module.exports&&(module.exports=Cli);
