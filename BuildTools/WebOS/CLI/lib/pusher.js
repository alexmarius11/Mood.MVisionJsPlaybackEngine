var fs=require("fs"),async=require("async"),log=require("npmlog"),util=require("util"),path=require("path"),streamBuffers=require("stream-buffers"),novacom=require("./novacom");
(function(){function p(){this.sources=[];this.destination=null}function q(e,b,a,d,c,m){log.verbose("copyFilesToNewDir()","src:",b,", dst:",a);var f=this;async.waterfall([fs.lstat.bind(fs,b),function(h,k){if(h.isDirectory()){log.verbose("copyFilesToNewDir()","src is a directory");d===l.FILE&&k(Error("The desination exists as a file."));a=path.join(a,path.basename(b));var n=fs.readdirSync(b);0===process.platform.indexOf("win")&&(a=a.replace(/\\/g,"/"));1===b.length||c.ignore||console.log("Push:",b,
"->",a);r(e,a,function(h){async.forEach(n,function(h,g){var d=path.join(b,h);q.call(f,e,d,a,l.NEW,c,function(a){g(a)})},function(a){k(a)})})}else{var g;d===l.FILE?(g=a,a=path.join(a,"..")):g=path.join(a,path.basename(b));0===process.platform.indexOf("win")&&(a=a.replace(/\\/g,"/"),g=g.replace(/\\/g,"/"));r(e,a,function(d){log.verbose("copyFilesToNewDir()","mkDir#dst:",a,",err:",d);e.put(b,g,function(a){if(!a){var d=h.size;c.ignore||console.log("Push:",b,"->",g);f.copyfilesCount++;f.totalSize+=d}k(a)})})}}],
function(a){m(a)})}function r(e,b,a){async.series([e.run.bind(e,"/bin/mkdir -p "+b,null,null,null)],function(b){b&&1==b.code&&(b=Error("Failed creation of directory due to permission error in the destination path"));a(b)})}function t(e,b,a){var d=new streamBuffers.WritableStreamBuffer,c="[ -d %s ] && echo 'd' || ([ -f %s ] && echo 'f' || echo 'n')";0===process.platform.indexOf("win")&&(b=b.replace(/\\/g,"/"));c=util.format(c,b,b);e.run(c,null,d,null,function(b){var c=d.getContentsAsString().trim();
log.verbose("Puser#push()","destionation type:",c);a(b,c)})}log.heading="push";log.level="warn";var l={FILE:"f",DIR:"d",NEW:"n"};module.exports=p;p.prototype.push=function(e,b,a,d){log.verbose("Puser#push()","srcPaths:",e,", dstPath:",b);var c=this,m,f;c.startTime=(new Date).getTime();c.copyfilesCount=0;c.totalSize=0;async.waterfall([function(b){if(a.session)return b(null,a.session);new novacom.Session(a.device,b)},function(c,d){a.session=c;t(c,b,function(a,b){m=b;!a&&b===l.FILE&&1<e.length&&(a=Error("The desination exists as a file."));
d(a)})},function(d){var k,h=a.session;async.eachSeries(e,function(d,n){async.waterfall([fs.lstat.bind(fs,d),function(a,c){k=b;a.isFile()&&1===e.length?(m===l.DIR&&(k=path.join(b,path.basename(d))),f=l.FILE):f=m;c()},function(b){q.call(c,h,d,k,f,a,b)}],function(a){n(a)})},d)}],function(a){var b={};if(!a){var e=((new Date).getTime()-c.startTime)/1E3;console.log(c.copyfilesCount+" file(s) pushed");console.log(Math.round(c.totalSize/(1024*e))+" KB/s ("+c.totalSize+" bytes in "+e+"s)");b.msg="Success"}d(a,
b)})}})();
